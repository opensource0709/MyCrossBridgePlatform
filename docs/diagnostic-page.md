# 測試診斷頁面開發計劃

## 頁面定位
- 路徑：/diagnostic
- 用途：用戶自我診斷 + 開發者測試演算法參數
- 分為一般模式（校準流程）和進階模式（參數調整）

## 開發階段

### 第一階段：裝置檢測基礎 ✅
- [x] 列出所有攝影機、麥克風、喇叭
- [x] 攝影機即時預覽
- [x] 麥克風音量指示條
- [x] 喇叭播放測試音
完成標準：三個裝置都可以選擇並測試正常

### 第二階段：音訊視覺化 ✅
- [x] 即時波形圖（時域）
- [x] 即時頻譜圖（FFT 頻域）
- [x] 音量數值顯示（目前音量、峰值、說話狀態）
完成標準：說話時波形圖和頻譜圖有明顯變化

### 第三階段：按鈕模式翻譯測試 ✅
- [x] 按住說話、放開送出
- [x] STT 辨識結果顯示
- [x] 翻譯結果顯示
- [x] 每個步驟延遲顯示（STT / 翻譯 / 總計）
- [x] 語言方向切換（中→越 / 越→中）
- [x] 翻譯歷史記錄
- [x] TTS 語音播放（ElevenLabs）
  - 翻譯結果旁邊有喇叭按鈕
  - 歷史記錄每筆都可播放
  - 中→越播放越南女聲，越→中播放中文聲音
完成標準：按住說中文，放開後看到越南文翻譯，點喇叭可聽語音

### 第四階段：自動校準流程 ✅
- [x] 即時音量大數字顯示
- [x] 四個可手動調整的參數輸入
- [x] 自動校準按鈕（靜音 5 秒 → 說話 5 秒）
- [x] 即時音量曲線圖（10 秒滾動）
- [x] 說話狀態指示器（持續顯示）
- [x] 參數儲存到 localStorage

**校準參數說明：**
| 參數 | 顏色 | 計算方式 | 說明 |
|------|------|----------|------|
| 靜音平均值 | 藍線 | 靜音採樣取平均值 | 背景噪音是持續穩定的聲音，用平均值更準確 |
| 說話最大值 | 綠線 | 說話採樣取最大值 | 人聲是脈衝波，用最大值才能捕捉到說話的峰值 |
| 判斷門檻 | 紅線 | (靜音平均值 + 說話最大值) / 2 | 區分說話與靜音的臨界值 |
| 句尾等待時間 | - | 預設 500ms | 說話停止後，等待這段時間才判定為句子結束 |

**句尾等待時間滑動延伸邏輯：**
```
音量超過門檻
  → 說話狀態持續到「目前時間 + N ms」

在 N ms 內任何時間點再次超過門檻
  → 說話狀態延伸到「該時間點 + N ms」

直到 N ms 內完全沒有超過門檻
  → 才判定說話結束
```

**即時音量曲線功能：**
- Y 軸動態自動縮放：max(曲線最大音量, 說話最大值, 判斷門檻×2) × 1.3
- 停止/繼續按鈕：暫停滾動以檢視歷史數據
- 滑鼠懸停：顯示該時間點的音量數值

完成標準：校準後說話指示器準確反映說話狀態

### 第五階段：連續模式 VAD ⏳
- [ ] 使用第四階段校準出來的參數
- [ ] Queue 緩衝機制（保留說話起點前 300ms 的聲音）
- [ ] 偵測到說話 → 開始錄音（含 Queue 緩衝）
- [ ] 句尾等待時間到 → 停止錄音 → 送 STT → 翻譯
- [ ] 即時顯示 VAD 狀態與錄音狀態

**VAD 流程：**
```
持續監聽音量
  ↓
音量 > 判斷門檻
  ↓
開始錄音（包含 Queue 緩衝的前 300ms）
  ↓
持續錄音，每次偵測到音量 > 門檻就重置句尾計時器
  ↓
句尾等待時間內都沒有超過門檻
  ↓
停止錄音 → 送 STT → 翻譯 → TTS 播放
```

完成標準：說話自動觸發錄音，停止說話自動送出翻譯

### 第六階段：進階參數調整 ⏳
- [ ] FFT 門檻滑桿
- [ ] 中位數視窗滑桿
- [ ] 移動平均視窗滑桿
- [ ] 閾值滑桿
- [ ] VAD 起點終點門檻滑桿
- [ ] Queue 大小滑桿
- [ ] 即時辨識率和誤觸率評分
完成標準：調整參數後即時看到效果變化

### 第七階段：網路與系統診斷 ⏳
- [ ] 網路延遲測試
- [ ] WebSocket 連線測試
- [ ] OpenAI / ElevenLabs / Deepgram API 狀態
- [ ] 後端伺服器狀態
- [ ] 一鍵診斷報告
完成標準：一鍵產生完整診斷報告

## 演算法參數說明

### 基本校準參數（第四階段）
| 參數 | 預設值 | 說明 |
|------|--------|------|
| 靜音平均值 | 5 | 背景噪音的平均音量 |
| 說話最大值 | 40 | 說話時的峰值音量 |
| 判斷門檻 | 22 | 區分說話與靜音的臨界值 |
| 句尾等待時間 | 500ms | 說話停止後等待多久才判定句子結束 |

### VAD 參數（第五階段）
| 參數 | 預設值 | 說明 |
|------|--------|------|
| Queue 緩衝 | 300ms | 保留說話起點前的聲音，避免漏掉開頭 |

### 進階參數（第六階段，未實作）
- FFT 門檻：過濾高頻雜訊
- 中位數視窗：消除脈衝噪音
- 移動平均視窗：平滑化數據

## UI 設計原則
- 一般用戶：只看到校準按鈕和快速選擇
- 開發者：點「進階設定」才看到所有參數
- 所有參數調整後即時生效，不需要重新整理

## 遠端測試模式

### 功能描述
兩台電腦各開啟 /diagnostic 頁面，
透過測試 ID 互相連線，模擬真實台越通話情境。

### UI 設計
- 系統自動產生測試 ID（6碼英數字，例如 ABC-123）
- 輸入對方 ID 後點連線
- 連線成功後進入雙向語音翻譯測試
- 兩端都可以看到對方的參數設定和延遲數值

### 技術實作
- 使用現有的 WebSocket 建立連線
- 不需要登入，用測試 ID 作為房間號碼
- 連線後流程與正式視訊通話相同

### 完成標準
兩台電腦互連後，可以進行完整的雙向語音翻譯測試
